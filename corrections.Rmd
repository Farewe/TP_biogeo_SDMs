---
title: "Correction du TP SDMs"
output: html_document
---


Sur cette page l'exemple utilisé est celui de *Neon valentulus*, mais le script est le même quelque soit l'espèce.

Assurez-vous d'être dans le bon répertoire de travail pour pouvoir exécuter le script : le répertoire doit contenir tous les fichiers de l'espèce considérée.

# 1. Chargement des données environnementales
```{r}
library(biomod2)
library(ggplot2)
library(terra)
library(geodata)

# Chargement des données climatiques
current <- rast("current.tif")
futuressp126 <- rast("futuressp126.tif")
futuressp585 <- rast("futuressp585.tif")

plot(current)

plot(futuressp585[[2]] - current [[2]])
```

# 2. Chargement des données d’occurrence

```{r}
# Chargement des données d'occurrence de l'espèce
P_points <- readRDS("P_points.RDS")

# Carte du monde (package)
wm <- world(path = "./")

plot(current[[1]])
plot(P_points, add = TRUE)
plot(wm, add = TRUE)
```


# 3. Préparation des données pour biomod
```{r}
run_data <- BIOMOD_FormatingData(resp.name = "Neonvalentulus", # Nom de l'espece
                                 resp.var = P_points, # Points de presence de l'espece
                                 expl.var = current, # Donnees environnemental de calibration : climat 1960-1990
                                 PA.nb.rep = 2, # Nombre de runs de pseudo-absences
                                 PA.nb.absences = 1000) # Nombre de pseudo-absences echantillonnees a chaque tour
# On sauve l'objet a chaque fois :
save(run_data, file = "run_data")
```

# 4. Calibration des modèles

```{r}
model_runs <- BIOMOD_Modeling(run_data, # Objet preparatoire
                              models =  c('GLM', 'RF', 'GBM'), # Modeles que l'on va faire tourner
                              nb.rep = 2, # Nombre de runs d'evaluation
                              data.split.perc = 80, # Quantite de donnees utilisees pour la validation croisee des modeles
                              # 80% pour la calibration, 20% pour la validation
                              prevalence = 0.5,
                              do.full.models = FALSE
)
save(model_runs, file = "model_runs")
```


# 5. Création du modèle d’ensemble

```{r}
em_runs <- BIOMOD_EnsembleModeling(model_runs, # Objet issu de l'etape 2
                                   models.chosen = 'all', # Utiliser tous les modeles calibres
                                   em.by = 'all', # Combiner tous les modèles ensemble 
                                   em.algo = "EMmean", # Faire la moyenne des probabilités individuelles
                                   metric.select = 'TSS', # Quelle métrique utiliser pour filtrer les mauvais modèles 
                                   metric.select.thresh = 0.6, # Quel seuil de filtration des mauvais modèles ? 
                                   metric.eval = c("TSS", "ROC"), # Quelles métriques utiliser pour évaluer l'EM ?
)


save(em_runs, file = "em_runs")
```


# 6.1 Projection des cartes actuelles
```{r}
projection_current <- BIOMOD_Projection(bm.mod = model_runs, # Objet issu de l'etape 4 (calibration des modeles individuels)
                                        new.env = current, # Donnees climatiques pour la projection
                                        proj.name = "current", # Nom de la projection
                                        models.chosen = 'all', # On projette tous les modeles
                                        metric.binary = "TSS", # Metrique utilisee pour transformer la proba de presence en presence-absence
                                        build.clamping.mask = TRUE) # Pour identifier les zones ou le climat est tres different du climat  utilise lors de la calibration
save(projection_current, file = "projection_current")

ef_current <- BIOMOD_EnsembleForecasting(bm.em = em_runs,  # Objet issu de l'etape 5 (ensemble modelling)
                                         bm.proj = projection_current, # Projections a rassembler pour l'ensemble forecasting
                                         metric.binary = "TSS")
save(ef_current, file = "ef_current")
```


# 6.2 Projection des cartes futures

```{r}
##### Projection dans le climat futur, RCP 2.6 #####
projection_futuressp126 <- BIOMOD_Projection(bm.mod = model_runs, # Objet issu de l'etape 4 (calibration des modeles individuels)
                                          new.env = futuressp126, # Donnees climatiques pour la projection
                                          proj.name = "futuressp126", # Nom de la projection
                                          models.chosen = 'all', # On projette tous les modeles
                                          metric.binary = "TSS", # Metrique utilisee pour transformer la proba de presence en presence-absence
                                          metric.filter = "TSS", # Metrique utilisee pour filtrer les 'mauvais' modeles
                                          build.clamping.mask = TRUE) # Pour identifier les zones ou le climat est tres different du climat  utilise lors de la calibration
save(projection_futuressp126, file = "futuressp126")

ef_futuressp126 <- BIOMOD_EnsembleForecasting(bm.em = em_runs,  # Objet issu de l'etape 5 (ensemble modelling)
                                              bm.proj = projection_futuressp126, # Projections a rassembler pour l'ensemble forecasting
                                              metric.binary = "TSS")
save(ef_futuressp126, file = "ef_futuressp126")

##### 4.3 Projection dans le climat futur, RCP 8.5 #####
projection_futuressp585 <- BIOMOD_Projection(bm.mod = model_runs, # Objet issu de l'etape 4 (calibration des modeles individuels)
                                             new.env = futuressp585, # Donnees climatiques pour la projection
                                             proj.name = "futuressp585", # Nom de la projection
                                             models.chosen = 'all', # On projette tous les modeles
                                             metric.binary = "TSS", # Metrique utilisee pour transformer la proba de presence en presence-absence
                                             metric.filter = "TSS", # Metrique utilisee pour filtrer les 'mauvais' modeles
                                             build.clamping.mask = TRUE) # Pour identifier les zones ou le climat est tres different du climat  utilise lors de la calibration
save(projection_futuressp585, file = "projection_futuressp585")

ef_futuressp585 <- BIOMOD_EnsembleForecasting(bm.em = em_runs,  # Objet issu de l'etape 5 (ensemble modelling)
                                           bm.proj = projection_futuressp585, # Projections a rassembler pour l'ensemble forecasting
                                           metric.binary = "TSS")
save(ef_futuressp585, file = "ef_futuressp585")
```


# 7. Evaluation des modèles

```{r}
# Verification de la qualite des modeles
evals <- get_evaluations(model_runs)
ggplot(evals, aes(x = algo, y = validation)) + geom_boxplot() + facet_grid(metric.eval ~ .)

```



```{r}
# Voir le seuil de conversion de proba vers presence-absence :
seuil <- get_evaluations(em_runs)[, "cutoff"]
seuil

```


# 8. Affichage des cartes de suitability

### Objet issu de `BIOMOD_EnsembleForecasting`
```{r}
# plot(ef_current)
```



### Récupération manuelle des rasters sur le disque
```{r}
# Cartes issues du modèle d'ensemble (environmental suitability) : 
current_projection <- rast("./Neonvalentulus/proj_current/proj_current_Neonvalentulus_ensemble.tif")
plot(current_projection)
proj_futuressp126_projection <- rast("./Neonvalentulus/proj_futuressp126/proj_futuressp126_Neonvalentulus_ensemble.tif")
plot(proj_futuressp126_projection)
proj_futuressp585_projection <- rast("./Neonvalentulus/proj_futuressp585/proj_futuressp585_Neonvalentulus_ensemble.tif")
plot(proj_futuressp585_projection)
```


# 9. Affichage des aires bioclimatiques potentielles (suitable vs. unsuitable)
```{r}
# Cartes binaires (1/0) calculées à partir de la probabilité moyenne du modèle d'ensemble 
current_binary <- rast("Neonvalentulus/proj_current/proj_current_Neonvalentulus_ensemble_TSSbin.tif")
futuressp126_binary <- rast("Neonvalentulus/proj_futuressp126/proj_futuressp126_Neonvalentulus_ensemble_TSSbin.tif")
futuressp585_binary <- rast("Neonvalentulus/proj_futuressp585/proj_futuressp585_Neonvalentulus_ensemble_TSSbin.tif")

plot(current_binary)
plot(futuressp126_binary)
plot(futuressp585_binary)
```

```{r}
# Create rasters containing the area of each suitable pixel
current_area <- cellSize(current_binary[[1]]) * current_binary[[1]]

plot(current_area)

# Calculate range size
# Current
global(current_area,
       stat = 'sum',
       na.rm = TRUE)



```


# 10. Effet des changements climatiques sur la probabilité de présence de l’espèce


```{r}
suitability <- c(current_projection, 
                 proj_futuressp126_projection,
                 proj_futuressp585_projection)
# On va mettre des noms explicites pour le graphique
names(suitability) <- c("Current", "Future SSP1-2.6", "Future SSP5-8.5")

plot(suitability)

pa <- c(current_binary, 
        futuressp126_binary,
        futuressp585_binary)
names(pa) <- c("Current", "Future SSP1-2.6", "Future SSP5-8.5")

plot(pa)
```

C'est la cata pour le climat de cette espèce !!! Va-t-elle disparaître ? Impossible d'y répondre sans savoir si elle peut s'adapter ou pas, sans connaître l'état des populations, etc.! Mais en tout cas, le changement climatique se présente comme une menace sérieuse au vu de ce que l'on sait de cette espèce.

# 11. Changements prédits de l’aire bioclimatique potentielle
```{r}
diff_rangesize <- BIOMOD_RangeSize(proj.current = current_binary[[1]],
                                   proj.future = futuressp585_binary[[1]])

plot(diff_rangesize$Diff.By.Pixel,
     col = c("red", "blue", "white", "purple"))

diff_rangesize
```

La différence d'aire est obtenue avec l'opération suivante : `future - 2 * current`
où current et future sont les projections binaires actuelles et futures.

Les pixels peuvent prendre 4 valeurs à l'issue de cette opération, en fonction de la valeur actuelle (1/0) et future (1/0) :

| current | future | résultat | signification |
|---------|--------|--------|--------|
| 1 | 0 | -2 | aire qui devient défavorable dans le futur |
| 1 | 1 | -1 | aire actuellement favorable qui reste favorable dans le futur |
| 0 | 1 | 1 | aire actuellement défavorable qui devient favorable dans le futur |
| 0 | 0 | 0 | aire défavorable (actuel et futur) |

Calculez les changements prédits de l’aire bioclimatique potentielle entre l’actuel et le futur sous le scénario RCP 8.5. Affichez la carte des changements. Que pensez-vous de ces résultats ? Qu’en déduisez-vous quant au futur de votre espèce ?

C'est la cata ! Le changement climatique apparait comme une menace sérieuse au vu des modèles. Il est important de s'intéresser à l'état de santé des populations pour s'assurer qu'elles vont pouvoir s'adapter aux CC à venir : adaptation, migration...


Pourquoi observe-t-on des différences entre nos calculs à l'étape 9 et cette étape ? Que faut-il faire ?

Les calculs ici sont en pixels, tandis que nos calculs à l'étape 9 étaient en km². Les pixels étant de tailles différentes, il vaut mieux éviter de faire des calculs en pixels, utilisez toujours les surfaces en km² !

# Bonus : incertitude calculée avec l'écart-type de la suitability
```{r}
# Calcul de l'incertitude : écart type de suitability
current_all <- rast("Neonvalentulus/proj_current/proj_current_Neonvalentulus.tif")
futuressp126_all <- rast("Neonvalentulus/proj_futuressp126/proj_futuressp126_Neonvalentulus.tif")
futuressp585_all <- rast("Neonvalentulus/proj_futuressp585/proj_futuressp585_Neonvalentulus.tif")
# N'hésitez pas à afficher ces stacks pour voir l'ensemble des modèles individuels

# On crée un stack dans lequel on calcule l'écart type des probas de présence pour chaque projection
uncertainty <- c(app(current_all, sd), 
                 app(futuressp126_all, sd),
                 app(futuressp585_all, sd))
names(uncertainty) <- c("Current", "Future SSP1-2.6", "Future SSP5-8.5")

plot(uncertainty)

```


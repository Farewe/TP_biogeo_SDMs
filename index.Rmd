---
title: "TP modélisation des aires de répartition"
output:
  html_document
---


Vous allez modéliser la distribution potentielle de l’espèce *Neon
valentulus*.

# Préparation des données

[Téléchargez les données nécessaires au TP en cliquant ici](https://borisleroy.com/files/TP_biogeo_SDMs.zip)

Extrayez les données dans un répertoire de travail pour R. 

# 1. Chargement des données environnementales

### Objectifs

Chargez les rasters de données climatiques actuelles et futures. Affichez les
différentes variables environnementales sur la période historique.
Comparez les changements prédits entre 
la période historique et la période 2050-2080 sur la variable de température 
minimale du mois le plus froid.

### Aide R

Vous allez utiliser le package `terra` qui permet de traiter des données 
spatiales sous R. Pour lire un raster, il faut utiliser la fonction `rast()` du 
package `terra`. On peut afficher un raster stack avec la fonction `plot()`. 
Quand le raster chargé est un stack (= empilement de plusieurs couches rasters),
on peut sélectionner un sous-ensemble avec `[[ ]]`. On peut faire des opérations
simples sur plusieurs rasters/stacks telles qu’une soustraction.


| Variable | Description | Unit  |
| ------   | ------      | ------| 
| BIO1     | Annual Mean Temperature| °C * 10 | 
| BIO2    | Mean Diurnal Range (Mean of monthly (max temp - min temp)) | °C * 10 | 
| BIO3 | Isothermality (BIO2/BIO7) (* 100) | Unitless | 
| BIO4 | Temperature Seasonality (standard deviation *100) | °C * 1000 | 
| BIO5 | Max Temperature of Warmest Month | °C * 10 | 
| BIO6 | Min Temperature of Coldest Month | °C * 10 | 
| BIO7 | Temperature Annual Range (BIO5-BIO6) | °C * 10 | 
| BIO8 | Mean Temperature of Wettest Quarter |  °C * 10 |
| BIO9 | Mean Temperature of Driest Quarter | °C * 10 |
| BIO10 | Mean Temperature of Warmest Quarter | °C * 10 |
| BIO11 | Mean Temperature of Coldest Quarter | °C * 10 |
| BIO12 | Annual Precipitation | mm |
| BIO13 | Precipitation of Wettest Month | mm |
| BIO14 | Precipitation of Driest Month | mm |
| BIO15 | Precipitation Seasonality (Coefficient of Variation) | unitless |
| BIO16 | Precipitation of Wettest Quarter | mm |
| BIO17 | Precipitation of Driest Quarter | mm |
| BIO18 | Precipitation of Warmest Quarter | mm |
| BIO19 | Precipitation of Coldest Quarter | mm |


-------


# 2. Chargement des données d’occurrence

### Objectifs

Chargez les données de présences d’espèces contenues dans `P_points.RDS`. 
Affichez les données de présence sur la carte d’une des variables environnementales actuelles. Ajoutez les limites des pays.

### Aide R

Pour lire un fichier RDS dans R il faut utiliser la fonction `readRDS()`.
Pour avoir les limites des pays, on peut soit télécharger les données depuis 
un site tel quel natural earth data, soit utiliser le package `geodata`, avec 
par exemple la fonction `world()` qui retourne les limites des pays.


# 3. Préparation des données pour biomod

### Objectifs

Préparez les données avec biomod2 dans un objet appelé `run_data`.
Indiquez le nombre de runs de pseudo-absences que vous souhaitez faire (par 
exemple, ici, faites deux runs), et le 
nombre de pseudo-absences que vous voulez générer (par exemple ici, 1000 pseudo-
absences). 
Sauvez `run_data` sur le disque dur

### Aide R

Fonctions `BIOMOD_FormatingData()` et `save()`  :
```
run_data <- BIOMOD_FormatingData(resp.name = "Nom_espece", # Nom de l'espece
                                 resp.var = YYY, # Points de presence de l'espece
                                 expl.var = XXX, # Donnees environnemental de calibration : climat 1950-2000
                                 PA.nb.rep = ZZZ, # Nombre de runs de pseudo-absences
                                 PA.nb.absences = AAA) # Nombre de pseudo-absences echantillonnees a chaque tour
                                 
save(run_data, file = "run_data")
```

# 4. Calibration des modèles


### Objectifs

Calibrez les modèles de niche et sauvez les dans un objet appelé `model_runs`. Choisissez trois modèles parmi ceux que biomod2 propose (éviter MaxEnt). Préciser un protocole de calibration simple : 2 répétitions d’évaluation-croisée, 80 % du jeu de données alloué à la calibration et 20% pour l'évaluation, poids équilibrés entre présences et pseudo-absences. Sauvez l’objet `model_runs` sur le disque dur.

### Aide R

Fonction `BIOMOD_Modeling()`
```
BIOMOD_Modeling(run_data, # Objet preparatoire
                models =  c('XXX', 'YYY', 'ZZZ'), # Modeles que l'on va faire tourner
                nb.rep = X, # Nombre de runs d'evaluation
                data.split.perc = Y,  # Séparation du jeu de données pour la 
                    # validation croisée :
                    # X% pour la calibration, (100 - X)% pour la validation
                prevalence = 0.5, # Equilibre des poids entre présences et pseudo-absences
)
```

# 5. Création du modèle d’ensemble

### Objectifs

Créez un modèle d’ensemble à partir de vos trois modèles individuels, dans un objet appelé `em_runs`. Utilisez tous les modèles pour créer un modèle d’ensemble unique qui
sera la moyenne des probabilités de présence de tous les modèles individuels. Eliminez les mauvais modèles du modèle
d'ensemble, en mettant un seuil de qualité minimale à 0.6 pour la métrique TSS. Sauvez l’objet em_runs sur le disque dur.

### Aide R

Fonction `BIOMOD_EnsembleModeling()`

```
BIOMOD_EnsembleModeling(model_runs, # Objet issu de l'etape 4
                        models.chosen = 'all', # Faire UN modele d'ensemble avec TOUS les modeles calibres
                        em.by = 'all', # Combiner tous les modèles ensemble 
                        em.algo = XXX, # Faire la moyenne des probabilités individuelles
                        metric.select = YYY, # Quelle métrique utiliser pour filtrer les mauvais modèles 
                        metric.select.thresh = ZZZ, # Quel seuil de filtration des mauvais modèles ? 
                        metric.eval = c("TSS", "ROC"), # Quelles métriques utiliser pour évaluer l'EM ?
)
```


# 6.1 Projection des cartes actuelles

### Objectifs 1

Projetez les cartes de répartition actuelles de l’espèce à partir des modèles calibrés, dans un objet appelé `projection_current`.  Fournissez bien les données environnementales actuelles à biomod2 pour qu'il projette la répartition dessus. Faites la conversion en présence-absence en demandant à biomod d'utiliser le seuil qui optimise la valeur du TSS.
Sauvez l’objet `projection_current` sur le disque dur.

### Aide R 1

Fonction `BIOMOD_Projection`
```
BIOMOD_Projection(bm.mod = model_runs, # Objet issu de l'etape 4 (calibration des modeles individuels)
                  new.env = XXX, # Donnees climatiques pour la projection
                  proj.name = "XXX", # Nom de la projection
                  models.chosen = 'all', # On projette tous les modeles
                  metric.binary = "TSS" # Metrique utilisee pour transformer la proba de presence en presence-absence) # Pour identifier les zones ou le climat est tres different du climat  utilise lors de la calibration
                          
```

### Objectifs 2


Projetez les cartes de répartition moyennes (= modèle d’ensemble). Faites la conversion en présence-absence en optimisant la valeur du TSS.

### Aide R 2 
Fonction `BIOMOD_EnsembleForecasting`
```
BIOMOD_EnsembleForecasting(bm.em = em_runs,  # Objet issu de l'etape 5 (paramétrisation de l'ensemble modelling)
                           bm.proj = projection_current, # Projections a rassembler pour l'ensemble forecasting
                           metric.binary = "TSS")
```

# 6.2 Projection des cartes futures

Projetez ensuite les cartes de répartition futures suivant les deux scénarios en veillant bien à mettre des **noms explicites**, en  reproduisant l'étape **6.1** pour chaque scénario.


# 7. Evaluation des modèles

### Objectifs
Récupérez les évaluations des modèles et évaluez la qualité de vos calibrations.

### Aide R
Fonction `get_evaluations()`
Exemple de script pour un graphique avec ggplot2 :

```
evals <- get_evaluations(model_runs)
ggplot(evals, aes(x = algo, y = validation)) + geom_boxplot() + facet_grid(metric.eval ~ .)
```

Il existe d'autres fonctions dans biomod2 pour afficher les évaluations, 
n'hésitez pas à les explorer !

# 8. Affichage des cartes de suitability

### Objectifs

Affichez les cartes de suitability des modèles d'ensemble produits par biomod2, 
en chargeant les rasters depuis le disque dur sans passer par biomod.
Elles sont localisées dans le dossier de votre espèce, puis dans le sous-dossier
proj_current (ou proj_<nom de votre projection>). Dans ce sous-dossier il y a 
plusieurs fichiers. Chargez le fichier issu du modèle d’ensemble qui n’est pas
converti en binaire (indice : le nom doit ressembler à
`proj_<nom de la projection>_<nom espece>_ensemble.tif`)

### Aide R

Charger avec la fonction `rast()` du package `terra` 

# 9. Affichage des aires bioclimatiques potentielles (suitable vs. unsuitable)

### Objectifs

Chargez les cartes binaires localisées dans le même sous-dossier qu’à l’étape 8, mais cette fois-ci en prenant le fichier issu du modèle d’ensemble qui est converti en binaire. Affichez ces cartes.
(indice : le nom est identique qu'à l'étape 8, mais il contient `TSSbin` en plus)

Calculez la taille de l’aire actuelle de l’espèce. 

### Aide R
La fonction `cellSize()` de `terra` donne la surface en km² de chaque pixel.
La fonction `global()` permet de faire des opérations sur un raster,
telles que la somme.

# 10. Effet des changements climatiques sur la suitability de l’espèce

### Objectifs
Affichez simultanément les cartes actuelles et futures de suitability de l’espèce. Qu’en déduisez-vous ?


# 11. Changements prédits de l’aire bioclimatique potentielle

### Objectifs
Calculez les changements prédits de l’aire bioclimatique potentielle entre l’actuel et le futur sous le scénario SSP 5 - 8.5. Affichez la carte des changements. Que pensez-vous de ces résultats ? Qu’en déduisez-vous quant au futur de votre espèce ?

Pourquoi observe-t-on des différences entre nos calculs à l'étape 9 et cette étape ? Que faut-il faire ?

### Aide R
Fonction `BIOMOD_RangeSize` 


[.](https://farewe.github.io/TP_biogeo_SDMs/corrections.html)